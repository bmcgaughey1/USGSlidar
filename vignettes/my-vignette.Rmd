---
title: "USGSlidar -- Basics"
author: "Robert J. McGaughey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{USGSlidar -- Basics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overall Goal

The USGSlidar package was developed to make it somewhat easy to query the collection of
lidar data available from the U.S. Geological Survey's 3D Elevation Program (and other sources)
to find out if data are available for specific locations of interest. The package 
accesses some of the project and tile index files available from 3DEP and uses them to
search for data. The package also provides links to lidar data files that can be downloaded
for free directly from 3DEP servers.

The package also facilitates access to the USGS lidar collection maintained in Entwine format.
This collection contains a subset of the data available from USGS but it is constantly being
updated to match the data available in the national map. The index for the Entwine collection
does not contain detailed project information so there is extra effort required to marry the
Entwine index with information in the USGS 3DEP collection.

## Packages

Load the packages needed for the examples.

```{r setup, echo=T, results='hide', error=F, warning=F, message=F}
library(ggplot2)
library(ggspatial)
library(USGSlidar)
```

## Example 1 -- Query USGS Entwine lidar collection

Using the USGS Entwine data collection, query for coverage for a buffered point location. The Entwine
data collection is in the web mercator projection (EPSG:3857). The point coordinate is also in the web
mercator projection. Buffer the point using a circular buffer with a radius of 500m.

The example point is located within the 2014 Glacier Peak lidar acquisition in Washington state.

```{r fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
# retrieve the entwine boundary index and store in current directory
fetchUSGSProjectIndex(type = "ENTWINE")

# query to find the project polygon(s) that covers the buffered point
# the return value is the project area polygon(s) that intersect buffered point
project_polys <- queryUSGSProjectIndex(-13499097
                                       , 6139669
                                       , buffer = 500
                                       , shape = "circle"
                                       , crs = "EPSG:3857"
#                                       , crs = sp::CRS(SRS_string="EPSG:3857")@projargs
)

# now query to get the sample area attributed with the project polygon information
# this is the same call as above but with return="aoi"
point_poly <- queryUSGSProjectIndex(-13499097
                                    , 6139669
                                    , buffer = 500
                                    , shape = "circle"
                                    , return = "aoi"
                                    , crs = "EPSG:3857"
#                                    , crs = sp::CRS(SRS_string="EPSG:3857")@projargs
)

# display the project area polygon and the buffered point
ggplot() +
  ggtitle("2014 Glacier Peak lidar") +
  annotation_map_tile(type = "osm") +
  layer_spatial(project_polys, fill = "cornsilk", alpha = 0.5) +
  annotation_spatial(point_poly, fill = "red")
```

